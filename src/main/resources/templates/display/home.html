<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>이커머스 메인 페이지</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/display.css}">
</head>
<body>
<header>
    <h1>INNO Market</h1>
    <nav>
        <ul>
            <li><a href="#">홈</a></li>
            <li><a href="#">카테고리 1</a></li>
            <li><a href="#">카테고리 2</a></li>
            <li><a href="#">카테고리 3</a></li>
        </ul>
    </nav>
</header>

<main>
    <section>
        <h2>추천 상품</h2>
        <div class="item-list" id="item-list">
            <div class="item" th:each="item : ${itemList}">
                <img th:src="@{/images/상품이미지.jpeg}" alt="상품 이미지">
<!--                <img th:src="${item.imageUrl}" th:alt="${item.name} Image" alt="상품 이미지">-->
                <h3 th:text="${item.itemName}">상품 제목</h3>
                <p th:text="${item.description}">상품 설명</p>
                <p th:text="'재고: ' + ${item.itemStock} + '개'">수량</p>
                <span th:text="'가격: ₩' + ${item.itemPrice}">가격: ₩10000</span>
            </div>
        </div>
        <div id="loading-skeleton" class="skeleton" style="display: none;">
            <div class="skeleton-content">
                <div class="skeleton-box">
                </div>
                <div class="skeleton-box">
                </div>
                <div class="skeleton-box">
                </div>
            </div>
        </div>
    </div>

    </section>
</main>

<footer>
    <p>© 2024 이커머스. All rights reserved.</p>
</footer>
<script>
    let currentPage = 0;  // 초기 페이지 값
    const size = 18;  // 한 번에 가져올 아이템 수
    let isLoading = false;  // 데이터 로딩 중 여부를 나타내는 플래그
    let isFinished = false; // 모든 데이터를 가져왔는지 여부를 나타내는 플래그

    // Intersection Observer 생성
    const observer = new IntersectionObserver(entries => {
        // 마지막 아이템이 화면에 보이면 새로운 데이터 로드
        if (entries[0].isIntersecting && !isLoading && !isFinished) {  // 로딩 중이 아니고, 모든 데이터를 가져오지 않았을 때
            isLoading = true;  // 로딩 상태로 변경
            fetchMoreItems();  // 새로운 데이터 로드
            observer.unobserve(entries[0].target);
        }
    }, {
        // 타겟이 뷰포트에 들어오는 지점을 지정합니다.
        threshold: 0.1
    });

    // 페이지 로드 시 첫 번째 데이터 가져오기
    document.addEventListener('DOMContentLoaded', () => {
        observer.observe(document.querySelector('.item-list .item:last-child'));
    });

    function fetchMoreItems() {
        currentPage += 1;  // 페이지 값을 증가시킴
        const url = `/v1/api/items?page=${currentPage}&size=${size}`;

        // // 스켈레톤 표시
        document.getElementById('loading-skeleton').style.display = 'flex';

        fetch(url)
            .then(response => response.json())
            .then(rep => {
                if (rep.data.length === 0) { // 받아올 데이터가 없을 때
                    isFinished = true; // 모든 데이터를 가져왔다고 플래그를 설정합니다.
                    document.getElementById('loading-skeleton').style.display = 'none';
                    return;
                }
                const itemList = document.getElementById('item-list');
                rep.data.forEach(item => {
                    const newItem = document.createElement('div');
                    newItem.classList.add('item');
                    newItem.innerHTML = `
                        <img th:src="@{/images/상품이미지.jpeg}" alt="상품 이미지">
                        <h3>${item.itemName}</h3>
                        <p>${item.description}</p>
                        <p>재고: ${item.itemStock}개</p>
                        <span>가격: ₩${item.itemPrice}</span>
                    `;
                    itemList.appendChild(newItem);
                });

                // 마지막 아이템 관찰 대상으로 추가
                observer.observe(document.querySelector('.item-list .item:last-child'));

                // 스켈레톤 숨기기
                document.getElementById('loading-skeleton').style.display = 'none';
                isLoading = false;  // 데이터 로딩 상태 해제
            })
            .catch(error => {
                console.error('Error fetching items:', error);
                document.getElementById('loading-skeleton').style.display = 'none';
                isLoading = false;  // 데이터 로딩 상태 해제
            });
    }
</script>
</body>
</html>